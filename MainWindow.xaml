<Window x:Class="M0XMusicPlayer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:M0XMusicPlayer"
        mc:Ignorable="d"
        Title="M0X Music Player" Height="600" Width="800"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        MinWidth="450" MinHeight="500"
        FontFamily="Segoe UI"
        AllowDrop="True" Drop="Window_Drop"
        MouseLeftButtonDown="Window_MouseLeftButtonDown"
        MouseEnter="Window_MouseEnter"
        MouseLeave="Window_MouseLeave">

    <Window.Resources>
        <local:CornerRadiusConverter x:Key="CornerRadiusConverter"/>

        <!-- Base style for control buttons -->
        <Style x:Key="BaseControlButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#DDDDDD"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="{Binding Path=Width, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource CornerRadiusConverter}}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="#3FFFFFFF"/></Trigger>
                <Trigger Property="IsPressed" Value="True"><Setter Property="Background" Value="#5FFFFFFF"/></Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ControlButton" BasedOn="{StaticResource BaseControlButton}" TargetType="Button"><Setter Property="Width" Value="40"/><Setter Property="Height" Value="40"/><Setter Property="Margin" Value="5,0"/></Style>
        <Style x:Key="WidgetControlButton" BasedOn="{StaticResource BaseControlButton}" TargetType="Button"><Setter Property="Width" Value="28"/><Setter Property="Height" Value="28"/><Setter Property="Margin" Value="2,0"/></Style>
        <Style x:Key="WindowControlButton" BasedOn="{StaticResource BaseControlButton}" TargetType="Button"><Setter Property="Width" Value="30"/><Setter Property="Height" Value="30"/><Setter Property="FontSize" Value="14"/></Style>
        
        <!-- Modern Style for the Playback Slider -->
        <Style x:Key="ModernSliderThumb" TargetType="{x:Type Thumb}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Thumb}">
                        <Grid>
                            <Ellipse x:Name="grip"
                                     Fill="White"
                                     Width="12" Height="12"
                                     Opacity="0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="true">
                                <Setter TargetName="grip" Property="Opacity" Value="1"/>
                            </Trigger>
                            <Trigger Property="IsDragging" Value="true">
                                <Setter TargetName="grip" Property="Opacity" Value="1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type Slider}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Slider}">
                        <Grid VerticalAlignment="Center">
                            <Border x:Name="TrackBackground" Height="4" CornerRadius="2" Background="#505050" />
                            <Border x:Name="PART_SelectionRange" Height="4" CornerRadius="2" Background="White" HorizontalAlignment="Left" />
                            <Track x:Name="PART_Track">
                                <Track.Thumb>
                                    <Thumb Style="{StaticResource ModernSliderThumb}" />
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Image x:Name="BackgroundImage" Stretch="UniformToFill">
            <Image.Effect><BlurEffect Radius="50" KernelType="Gaussian"/></Image.Effect>
        </Image>

        <Border x:Name="MainBorder" Background="#C0222222" CornerRadius="10">
            <Grid>
                <!-- Normal Player View -->
                <Grid x:Name="NormalViewGrid">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition x:Name="PlaylistColumn" Width="220"/>
                    </Grid.ColumnDefinitions>
                    <Grid Grid.Column="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/><!-- Title Bar -->
                            <RowDefinition Height="*"/><!-- Album Art -->
                            <RowDefinition Height="Auto"/><!-- Track Info -->
                            <RowDefinition Height="Auto"/><!-- Controls -->
                        </Grid.RowDefinitions>
                        <Grid Grid.Row="0" Height="40" Background="Transparent">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="PinButton" Style="{StaticResource WindowControlButton}" Click="PinButton_Click" ToolTip="Compact Mode"><Path Data="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" Fill="#CCCCCC" Width="16" Height="16" Stretch="Uniform"/></Button>
                                <Button Content="—" Style="{StaticResource WindowControlButton}" Click="MinimizeButton_Click"/>
                                <Button Content="☐" Style="{StaticResource WindowControlButton}" Click="MaximizeButton_Click"/>
                                <Button Content="✕" Style="{StaticResource WindowControlButton}" Click="CloseButton_Click" Foreground="IndianRed"/>
                            </StackPanel>
                        </Grid>
                        <Border x:Name="NormalVinylCover" Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center" Width="300" Height="300" CornerRadius="150" Margin="20" RenderTransformOrigin="0.5,0.5">
                            <Border.Effect><DropShadowEffect ShadowDepth="0" Color="Black" Opacity="0.5" BlurRadius="30"/></Border.Effect>
                            <Border.Background><ImageBrush x:Name="AlbumArtBrush" Stretch="UniformToFill"/></Border.Background>
                        </Border>
                        <StackPanel Grid.Row="2" Margin="20,0,20,20" VerticalAlignment="Bottom">
                            <TextBlock x:Name="TitleText" Text="M0X Music Player" FontSize="28" FontWeight="Light" Foreground="White" TextAlignment="Center" TextTrimming="CharacterEllipsis"/>
                            <TextBlock x:Name="ArtistAlbumText" Text="Drag &amp; Drop Music to Start" FontSize="16" Foreground="#BBBBBB" TextAlignment="Center" Margin="0,5,0,15"/>
                            <Grid Margin="10,0">
                                <Grid.ColumnDefinitions><ColumnDefinition Width="Auto"/><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                <TextBlock x:Name="CurrentTimeText" Grid.Column="0" Text="0:00" Foreground="#CCCCCC" VerticalAlignment="Center"/>
                                <Slider x:Name="PositionSlider" Grid.Column="1" Margin="10,0" VerticalAlignment="Center" Thumb.DragStarted="PositionSlider_DragStarted" Thumb.DragCompleted="PositionSlider_DragCompleted"/>
                                <TextBlock x:Name="TotalTimeText" Grid.Column="2" Text="0:00" Foreground="#CCCCCC" VerticalAlignment="Center"/>
                            </Grid>
                        </StackPanel>
                        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,20">
                            <Button x:Name="ShuffleButton" Style="{StaticResource ControlButton}" Click="ShuffleButton_Click" ToolTip="Shuffle Playlist"><Path Data="M10.59,9.17L5.41,4L4,5.41L9.17,10.59L10.59,9.17M14.5,4L16.54,6.04L4,18.59L5.41,20L17.96,7.46L20,9.5V4H14.5M5.41,10L4,11.41L12.59,20L14,18.59L5.41,10Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/></Button>
                            <Button x:Name="PreviousButton" Style="{StaticResource ControlButton}" Click="PreviousButton_Click" ToolTip="Previous Track"><Path Data="M6,18V6H8V18H6M9.5,12L18,6V18L9.5,12Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/></Button>
                            <Button x:Name="PlayPauseButton" Style="{StaticResource ControlButton}" Width="60" Height="60" Margin="10,0" Click="PlayPauseButton_Click" ToolTip="Play"><Path x:Name="PlayPauseIcon" Data="M8,5.14V19.14L19,12.14L8,5.14Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/></Button>
                            <Button x:Name="NextButton" Style="{StaticResource ControlButton}" Click="NextButton_Click" ToolTip="Next Track"><Path Data="M16,18H18V6H16V18M4,18L12.5,12L4,6V18Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/></Button>
                            <Button Style="{StaticResource ControlButton}" Click="LoadFilesButton_Click" ToolTip="Open Files"><Path Data="M9,16V10H5L12,3L19,10H15V16H9M5,20H19V18H5V20Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"/></Button>
                        </StackPanel>
                    </Grid>
                    <Grid Grid.Column="1" Background="#33000000">
                        <Grid.RowDefinitions><RowDefinition Height="*"/><RowDefinition Height="Auto"/></Grid.RowDefinitions>
                        <ListBox x:Name="Playlist" Grid.Row="0" Background="Transparent" BorderThickness="0" Foreground="#DDDDDD" Margin="5,45,5,5" MouseDoubleClick="Playlist_MouseDoubleClick">
                            <ListBox.ItemTemplate><DataTemplate><TextBlock Text="{Binding}" ToolTip="{Binding}" TextTrimming="CharacterEllipsis"/></DataTemplate></ListBox.ItemTemplate>
                        </ListBox>
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="10,10,10,20" VerticalAlignment="Center">
                            <Path Data="M3,9V15H7L12,20V4L7,9H3M14,11C14,9.21 13.23,7.67 12,6.8V17.2C13.23,16.33 14,14.79 14,13Z" Fill="#CCCCCC" VerticalAlignment="Center"/>
                            <Slider x:Name="VolumeSlider" Width="120" Margin="10,0" Minimum="0" Maximum="1" Value="0.5" ValueChanged="VolumeSlider_ValueChanged" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </Grid>

                <!-- New Compact Square Widget View -->
                <Grid x:Name="CompactViewGrid" Visibility="Collapsed" Background="Transparent">
                    <Grid Margin="5">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- FIX: Using a Viewbox to keep the Border square and making it overlap -->
                        <Viewbox Grid.Row="0" Grid.RowSpan="2" Margin="10,10,10,-15" Panel.ZIndex="1">
                            <Border x:Name="CompactVinylCover" Width="100" Height="100" CornerRadius="50" RenderTransformOrigin="0.5,0.5">
                                <Border.Background><ImageBrush x:Name="AlbumArtBrushCompact" Stretch="UniformToFill"/></Border.Background>
                            </Border>
                        </Viewbox>

                        <Slider Grid.Row="1" x:Name="PositionSliderCompact" Margin="5,10,5,0" Panel.ZIndex="0" IsEnabled="{Binding IsEnabled, ElementName=PositionSlider}" Maximum="{Binding Maximum, ElementName=PositionSlider}" Value="{Binding Value, ElementName=PositionSlider}" Thumb.DragStarted="PositionSlider_DragStarted" Thumb.DragCompleted="PositionSlider_DragCompleted"/>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,5,0,5">
                            <Button Style="{StaticResource WidgetControlButton}" Click="PreviousButton_Click" IsEnabled="{Binding IsEnabled, ElementName=PreviousButton}"><Path Data="M6,18V6H8V18H6M9.5,12L18,6V18L9.5,12Z" Fill="#CCCCCC" Width="12" Height="12" Stretch="Uniform"/></Button>
                            <Button Style="{StaticResource WidgetControlButton}" Width="36" Height="36" Click="PlayPauseButton_Click"><Path Data="{Binding Data, ElementName=PlayPauseIcon}" Fill="#CCCCCC" Width="14" Height="14" Stretch="Uniform"/></Button>
                            <Button Style="{StaticResource WidgetControlButton}" Click="NextButton_Click" IsEnabled="{Binding IsEnabled, ElementName=NextButton}"><Path Data="M16,18H18V6H16V18M4,18L12.5,12L4,6V18Z" Fill="#CCCCCC" Width="12" Height="12" Stretch="Uniform"/></Button>
                            <Button Style="{StaticResource WidgetControlButton}" Click="PinButton_Click" ToolTip="Exit Compact Mode"><Path Data="M2,5.27L3.28,4L20,20.72L18.73,22L12.8,16.07V22H11.2V16.07L6,11.07V16H4V14L6,12V11.27L2,7.27V5.27M8,4H7V2H17V4H16V12L18,14V16H17.27L8,6.73V4Z" Fill="#CCCCCC" Width="16" Height="16" Stretch="Uniform"/></Button>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>